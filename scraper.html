<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OpenCaselist Scraper</title>
  <style>
    :root {
      --bg: #f7faf8;
      --card: #ffffff;
      --accent: #7ea7a6;
      --accent-soft: #e8f1ef;
      --text: #2f3640;
      --muted: #6b7683;
      --border: #e3e7ea;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 32px;
      background: var(--bg);
      color: var(--text);
    }

    .shell {
      max-width: 960px;
      margin: 0 auto;
      background: var(--card);
      padding: 28px 32px 36px;
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: none;
    }

    h1 {
      font-size: 26px;
      margin: 0 0 18px;
      letter-spacing: 0.2px;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    input[type="text"] {
      padding: 10px 12px;
      width: min(420px, 100%);
      font-size: 16px;
      border-radius: 0;
      border: 1px solid var(--border);
      background: #fdfefe;
      color: var(--text);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(126, 167, 166, 0.2);
    }

    button {
      padding: 10px 16px;
      font-size: 15px;
      cursor: pointer;
      margin-left: 2px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 0;
      box-shadow: none;
      transition: transform 0.1s ease, opacity 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    button:active {
      transform: translateY(0);
    }

    #statusText {
      color: var(--muted);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 24px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 0;
      overflow: hidden;
      box-shadow: none;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 12px 12px;
      text-align: left;
      font-size: 14px;
      vertical-align: top;
    }

    th {
      background: var(--accent-soft);
      color: #3f5150;
      letter-spacing: 0.4px;
      font-size: 13px;
      text-transform: uppercase;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: #f7fbfa;
    }

    a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    a:hover {
      text-decoration: underline;
    }

    .round_report {
      color: var(--muted);
      line-height: 1.45;
    }
  </style>
</head>

<body>

  <div class="shell">
    <h1>cardscraper v2</h1>

    <div class="controls">
      <input id="searchInput" type="text" placeholder="Search (filename, school, etc.)" />
      <button id="searchButton">Search</button>
      <div id="statusText" style="font-size: 14px; display:inline-block;"></div>
    </div>

    <table id="resultsTable" style="display:none;">
      <thead>
        <tr>
          <th>Team</th>
          <th>School</th>
          <th>File</th>
          <th>Open Source Link</th>
          <th>Round Report</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

  <script>
    const CACHE_URLS = [
      "round_cache.json", // same folder
      "/round_cache.json" // site root fallback
    ];
    let rounds = [];
    let cacheLoaded = false;

    function setStatus(text) {
      document.getElementById("statusText").textContent = text || "";
    }

    async function loadCacheOnce() {
      if (cacheLoaded) return;
      setStatus("Loading cached roundsâ€¦");

      let lastError = null;
      for (const url of CACHE_URLS) {
        try {
          const resp = await fetch(url, { cache: "no-cache" });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          rounds = data.rounds || [];
          cacheLoaded = true;
          setStatus(`Loaded ${rounds.length} rounds`);
          return;
        } catch (err) {
          lastError = err;
        }
      }

      cacheLoaded = false;
      setStatus(`Error loading cache: ${lastError ? lastError.message : "unknown"}`);
      throw lastError || new Error("Failed to load cache");
    }

    function filterRounds(query) {
      const q = query.toLowerCase();
      return rounds.filter((r) => {
        const report = (r.report || "").toLowerCase();
        const team = (r.team || "").toLowerCase();
        const school = (r.school || "").toLowerCase();
        const tournament = (r.tournament || "").toLowerCase();
        return (
          report.includes(q) ||
          team.includes(q) ||
          school.includes(q) ||
          tournament.includes(q)
        );
      });
    }

    function renderResults(items) {
      const table = document.getElementById("resultsTable");
      const body = document.getElementById("resultsBody");
      body.innerHTML = "";

      if (!items.length) {
        table.style.display = "none";
        setStatus("No matches found");
        return;
      }

      items.forEach((item) => {
        const row = document.createElement("tr");
        // Normalize download path for direct API download; if missing, leave as null.
        const downloadPath =
          item.download_path ||
          (item.file_url && item.file_url.replace(/^\/?files\//, "")) ||
          null;
        const linkHref = downloadPath
          ? `https://api.opencaselist.com/v1/download?path=${encodeURIComponent(downloadPath)}`
          : null;

        const teamCell = document.createElement("td");
        teamCell.textContent = item.team || "";
        row.appendChild(teamCell);

        const schoolCell = document.createElement("td");
        schoolCell.textContent = item.school || "";
        row.appendChild(schoolCell);

        const fileCell = document.createElement("td");
        fileCell.textContent = item.tournament || "";
        row.appendChild(fileCell);

        const linkCell = document.createElement("td");
        if (linkHref) {
          const a = document.createElement("a");
          a.href = linkHref;
          a.target = "_blank";
          a.textContent = "Open Source";
          linkCell.appendChild(a);
        } else {
          linkCell.textContent = "N/A";
        }
        row.appendChild(linkCell);

        const snippetCell = document.createElement("td");
        snippetCell.className = "round_report";
        snippetCell.textContent = item.report || "";
        row.appendChild(snippetCell);

        body.appendChild(row);
      });

      table.style.display = "table";
      setStatus(`Found ${items.length} matches`);
    }

    async function performSearch() {
      const query = document.getElementById("searchInput").value.trim();
      if (!query) {
        setStatus("Enter a search term to begin");
        return;
      }

      try {
        await loadCacheOnce();
      } catch {
        return; // Status already set in loadCacheOnce
      }

      const results = filterRounds(query);
      renderResults(results);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("searchButton").addEventListener("click", performSearch);
      document
        .getElementById("searchInput")
        .addEventListener("keydown", (evt) => {
          if (evt.key === "Enter") {
            performSearch();
          }
        });
    });
  </script>

</body>
</html>
